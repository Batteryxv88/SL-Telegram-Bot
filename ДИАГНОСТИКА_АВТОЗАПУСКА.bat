@echo off
chcp 65001 >nul
title Диагностика автозапуска SL Bot
echo ═══════════════════════════════════════════════════════════════════════════════════
echo                           ДИАГНОСТИКА АВТОЗАПУСКА SL BOT
echo ═══════════════════════════════════════════════════════════════════════════════════
echo.

echo 🔍 ПРОВЕРКА 1: Наличие файлов
echo ────────────────────────────────────────────────────────────────────────────────
set "BOT_DIR=%~dp0SL_Bot_ГОТОВ"
echo Папка бота: %BOT_DIR%
echo.

if exist "%BOT_DIR%\SL_Bot_NoDeps.exe" (
    echo ✅ SL_Bot_NoDeps.exe найден
) else (
    echo ❌ SL_Bot_NoDeps.exe НЕ НАЙДЕН!
    goto :error
)

if exist "%BOT_DIR%\.env" (
    echo ✅ .env файл найден
) else (
    echo ❌ .env файл НЕ НАЙДЕН!
    goto :error
)

echo.
echo 🔍 ПРОВЕРКА 2: Задачи в планировщике
echo ────────────────────────────────────────────────────────────────────────────────
schtasks /query /tn "SL Bot Автозапуск" >nul 2>&1
if %errorlevel% equ 0 (
    echo ✅ Задача "SL Bot Автозапуск" найдена в планировщике
    echo.
    echo 📋 Информация о задаче:
    schtasks /query /tn "SL Bot Автозапуск" /fo LIST /v | findstr /i "Имя_задачи Состояние Следующий_запуск Последний_запуск Последний_результат"
) else (
    echo ❌ Задача "SL Bot Автозапуск" НЕ НАЙДЕНА в планировщике!
    echo.
    echo 🔧 РЕШЕНИЕ: Создайте задачу заново через taskschd.msc
    goto :solution
)

echo.
echo 🔍 ПРОВЕРКА 3: Процессы бота
echo ────────────────────────────────────────────────────────────────────────────────
tasklist /fi "imagename eq SL_Bot_NoDeps.exe" 2>nul | find /i "SL_Bot_NoDeps.exe" >nul
if %errorlevel% equ 0 (
    echo ✅ Бот ЗАПУЩЕН в данный момент
    echo.
    echo 📊 Информация о процессе:
    tasklist /fi "imagename eq SL_Bot_NoDeps.exe" /fo table
) else (
    echo ❌ Бот НЕ ЗАПУЩЕН в данный момент
)

echo.
echo 🔍 ПРОВЕРКА 4: Тест запуска бота
echo ────────────────────────────────────────────────────────────────────────────────
echo Попытка запуска бота для проверки...
cd /d "%BOT_DIR%"
timeout /t 3 >nul

echo Запуск SL_Bot_NoDeps.exe на 10 секунд для теста...
start /min "" "%BOT_DIR%\SL_Bot_NoDeps.exe"
timeout /t 10 >nul

tasklist /fi "imagename eq SL_Bot_NoDeps.exe" 2>nul | find /i "SL_Bot_NoDeps.exe" >nul
if %errorlevel% equ 0 (
    echo ✅ Бот успешно запустился при ручном тесте
    echo Останавливаем тестовый процесс...
    taskkill /f /im SL_Bot_NoDeps.exe >nul 2>&1
) else (
    echo ❌ Бот НЕ ЗАПУСТИЛСЯ при ручном тесте!
    echo.
    echo 🔧 ВОЗМОЖНЫЕ ПРИЧИНЫ:
    echo    - Отсутствует .env файл
    echo    - Неверные данные в .env
    echo    - Заблокирован антивирусом
    echo    - Нет доступа к интернету
    goto :solution
)

echo.
echo 🔍 ПРОВЕРКА 5: Логи бота
echo ────────────────────────────────────────────────────────────────────────────────
if exist "%BOT_DIR%\bot.log" (
    echo ✅ Файл логов найден
    echo.
    echo 📄 Последние 5 строк из bot.log:
    echo ────────────────────────────────────────────────────────────────────────────────
    powershell -command "Get-Content '%BOT_DIR%\bot.log' -Tail 5"
    echo ────────────────────────────────────────────────────────────────────────────────
) else (
    echo ❌ Файл логов НЕ НАЙДЕН (бот никогда не запускался)
)

echo.
echo ═══════════════════════════════════════════════════════════════════════════════════
echo                                    РЕЗУЛЬТАТ ДИАГНОСТИКИ
echo ═══════════════════════════════════════════════════════════════════════════════════
echo.
echo ✅ Если все проверки прошли успешно, но автозапуск не работает:
echo    1. Откройте taskschd.msc
echo    2. Найдите задачу "SL Bot Автозапуск"
echo    3. Правой кнопкой → Свойства
echo    4. Вкладка "Общие" → поставьте галочку "Выполнять с наивысшими правами"
echo    5. Вкладка "Условия" → уберите галочку "Запускать только при питании от сети"
echo    6. Нажмите ОК и перезагрузите компьютер
echo.
goto :end

:error
echo.
echo ❌ КРИТИЧЕСКАЯ ОШИБКА: Отсутствуют необходимые файлы!
echo.

:solution
echo 🔧 ПОШАГОВОЕ РЕШЕНИЕ:
echo ────────────────────────────────────────────────────────────────────────────────
echo 1. Убедитесь что файлы находятся в правильной папке:
echo    %BOT_DIR%
echo.
echo 2. Проверьте наличие файлов:
echo    ✓ SL_Bot_NoDeps.exe
echo    ✓ .env (с токенами)
echo.
echo 3. Создайте задачу в планировщике заново:
echo    - Win + R → taskschd.msc
echo    - Создать простую задачу
echo    - Имя: SL Bot Автозапуск
echo    - Триггер: При запуске компьютера
echo    - Программа: %BOT_DIR%\SL_Bot_NoDeps.exe
echo    - Рабочая папка: %BOT_DIR%
echo    - Галочки: "Выполнять с наивысшими правами"
echo.
echo 4. Альтернативный способ (папка автозагрузки):
echo    - Win + R → shell:startup
echo    - Скопируйте туда SL_Bot_NoDeps.exe или создайте ярлык
echo.

:end
echo.
echo 📞 Если проблема не решена, отправьте результаты этой диагностики
echo.
pause 