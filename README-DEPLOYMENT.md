# Инструкция по развертыванию SL Telegram Bot на Windows Server

## Предварительные требования

- ✅ Node.js установлен
- ✅ npm установлен
- ✅ Файлы бота скопированы на сервер
- ✅ Права администратора

## 1. Подготовка проекта

### 1.1. Копирование файлов
Скопируйте все файлы проекта в папку на сервере, например:
```
C:\bots\SL-bot\
```

### 1.2. Установка зависимостей
Откройте PowerShell от имени администратора и выполните:

```powershell
cd C:\bots\SL-bot
npm install
```

### 1.3. Проверка работоспособности
Убедитесь, что бот запускается:

```powershell
node index.js
```

Если бот работает, остановите его (Ctrl+C) и переходите к следующему шагу.

## 2. Установка и настройка PM2

### 2.1. Установка PM2
```powershell
npm install -g pm2
```

### 2.2. Установка PM2 Windows Startup
```powershell
npm install -g pm2-windows-startup
```

### 2.3. Настройка автозапуска
```powershell
pm2-startup install
```

## 3. Запуск и настройка бота

### 3.1. Запуск бота через PM2
```powershell
cd C:\bots\SL-bot
pm2 start index.js --name "sl-bot"
```

### 3.2. Сохранение конфигурации
```powershell
pm2 save
```

### 3.3. Проверка статуса
```powershell
pm2 status
```

Вы должны увидеть ваш бот в статусе "online".

## 4. Управление ботом

### 4.1. Основные команды управления

| Команда | Описание |
|---------|----------|
| `pm2 status` | Показать статус всех процессов |
| `pm2 restart sl-bot` | Перезапустить бота |
| `pm2 stop sl-bot` | Остановить бота |
| `pm2 start sl-bot` | Запустить остановленного бота |
| `pm2 delete sl-bot` | Удалить бота из PM2 |
| `pm2 logs sl-bot` | Показать логи бота |
| `pm2 logs sl-bot --lines 50` | Показать последние 50 строк логов |

### 4.2. Мониторинг в реальном времени
```powershell
# Логи в реальном времени
pm2 logs sl-bot

# Мониторинг ресурсов
pm2 monit
```

### 4.3. Управление всеми процессами
```powershell
# Перезапустить все процессы
pm2 restart all

# Остановить все процессы
pm2 stop all

# Удалить все процессы
pm2 delete all

# Принудительно завершить PM2
pm2 kill
```

## 5. Проверка автозапуска

### 5.1. Тестирование
1. Перезагрузите сервер
2. Подождите 2-3 минуты после загрузки Windows
3. Откройте PowerShell и выполните:
```powershell
pm2 status
```

Если бот показывается в статусе "online" - автозапуск работает корректно.

### 5.2. Устранение проблем автозапуска
Если бот не запустился автоматически:

```powershell
# Переустановите автозапуск
pm2-startup uninstall
pm2-startup install

# Убедитесь, что конфигурация сохранена
pm2 save
```

## 6. Обновление бота

### 6.1. Ручное обновление
```powershell
cd C:\bots\SL-bot

# Остановить бота
pm2 stop sl-bot

# Обновить файлы (скопировать новые версии)
# Установить новые зависимости если нужно
npm install

# Запустить бота
pm2 start sl-bot

# Сохранить конфигурацию
pm2 save
```

### 6.2. Создание скрипта обновления
Создайте файл `update-bot.bat`:

```batch
@echo off
echo Updating SL Bot...
cd /d "C:\bots\SL-bot"
pm2 stop sl-bot
echo Bot stopped. Please update files manually, then press any key to continue...
pause
npm install
pm2 start sl-bot
pm2 save
echo Bot updated and restarted!
pause
```

## 7. Резервное копирование

### 7.1. Создание бэкапа
Регулярно создавайте резервные копии:
- Файлов проекта (`C:\bots\SL-bot\`)
- Конфигурации PM2 (`pm2 dump`)

### 7.2. Восстановление из бэкапа
```powershell
# Восстановить процессы PM2
pm2 resurrect

# Или загрузить из файла дампа
pm2 start dump.pm2
```

## 8. Мониторинг и логирование

### 8.1. Ротация логов
```powershell
# Установить модуль ротации логов
pm2 install pm2-logrotate

# Настроить ротацию (опционально)
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
```

### 8.2. Очистка логов
```powershell
# Очистить все логи
pm2 flush

# Очистить логи конкретного процесса
pm2 flush sl-bot
```

## 9. Безопасность

### 9.1. Переменные окружения
Убедитесь, что файл `.env` содержит все необходимые токены и настройки:
```env
BOT_TOKEN=your_bot_token_here
# Другие переменные...
```

### 9.2. Права доступа
- Ограничьте доступ к папке с ботом
- Не храните токены в открытом виде в коде
- Регулярно обновляйте зависимости

## 10. Диагностика проблем

### 10.1. Основные проблемы и решения

| Проблема | Решение |
|----------|---------|
| Бот не запускается | Проверьте `pm2 logs sl-bot` |
| Автозапуск не работает | Переустановите `pm2-startup` |
| Высокое потребление памяти | Перезапустите бота `pm2 restart sl-bot` |
| Ошибки в логах | Проверьте токены и настройки |

### 10.2. Команды диагностики
```powershell
# Подробная информация о процессе
pm2 describe sl-bot

# Информация о системе
pm2 info

# Показать конфигурацию
pm2 dump
```

## 11. Полезные скрипты

### 11.1. Быстрый перезапуск (restart-bot.bat)
```batch
@echo off
cd /d "C:\bots\SL-bot"
pm2 restart sl-bot
echo Bot restarted!
pause
```

### 11.2. Проверка статуса (check-bot.bat)
```batch
@echo off
cd /d "C:\bots\SL-bot"
pm2 status
pm2 logs sl-bot --lines 10
pause
```

### 11.3. Полная переустановка (reinstall-bot.bat)
```batch
@echo off
cd /d "C:\bots\SL-bot"
pm2 delete sl-bot
pm2 start index.js --name "sl-bot"
pm2 save
echo Bot reinstalled!
pause
```

---

## Контакты и поддержка

При возникновении проблем:
1. Проверьте логи: `pm2 logs sl-bot`
2. Проверьте статус: `pm2 status`
3. Попробуйте перезапустить: `pm2 restart sl-bot`

**Важно:** Всегда делайте резервные копии перед внесением изменений! 